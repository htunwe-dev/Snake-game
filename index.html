<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HMA the Snake.io</title>
<style>
html, body { margin:0; padding:0; overflow:hidden; font-family:sans-serif; }
canvas { display:block; }
#leaderboard {
  position:absolute; top:10px; right:10px;
  background:rgba(0,0,0,0.7); color:white;
  padding:10px; border-radius:8px; min-width:170px;
  border: 2px solid white;
}
#leaderboard b { display:block; margin-bottom:5px; }
#menu { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.8); color:white; padding:20px; border-radius:10px; text-align:center;}
#menu input[type=text], #menu input[type=color] { margin:5px; padding:5px; width:120px; }
#menu button { padding:5px 10px; margin-top:10px; cursor:pointer; }
</style>
</head>
<body>
<canvas id="game"></canvas>

<div id="menu">
  <h2>HMA the Snake.io</h2>
  <div>
    Name: <input type="text" id="playerName" placeholder="New Player" maxlength="12"><br>
    Color: <input type="color" id="playerColor" value="#00ff00"><br>
    <button id="startBtn">Start Game</button>
  </div>
</div>

<div id="leaderboard"><b>Leaderboard</b><div id="scores"></div></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
// Firebase setup
const firebaseConfig = {
  apiKey: "AIzaSyCut9Zjh8Tv6DjUWeWbBI3zT9ZeujtUMmg",
  authDomain: "snakegame-89cb2.firebaseapp.com",
  databaseURL: "https://snakegame-89cb2-default-rtdb.firebaseio.com",
  projectId: "snakegame-89cb2",
  storageBucket: "snakegame-89cb2.appspot.com",
  messagingSenderId: "474294584354",
  appId: "1:474294584354:web:fe0583154e5f4f84e0f67b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Canvas setup
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// Map
const MAP_WIDTH = 2000;
const MAP_HEIGHT = 2000;

// Player
const playerId = Math.random().toString(36).substr(2,9);
let playerName = "New Player";
let color = "#00ff00";
let snake = { x:MAP_WIDTH/2, y:MAP_HEIGHT/2, dx:1, dy:0, segments:[{x:MAP_WIDTH/2,y:MAP_HEIGHT/2}], length:5, segmentSize:10, dead:true };

// Camera
let camX = 0, camY = 0;

// Food
const foods = [];
const maxFood = 200;
function spawnFood(){
  for(let i=foods.length;i<maxFood;i++){
    const size = Math.random()*12 + 4;
    let fcolor = size<8?'yellow':(size<12?'orange':'red');
    foods.push({x:Math.random()*MAP_WIDTH, y:Math.random()*MAP_HEIGHT, size, color:fcolor});
  }
}
spawnFood();

// Food from dead snake
function spawnFoodFromSnake(s){
  const pieces = Math.min(50, Math.ceil(s.length));
  for(let i=0;i<pieces;i++){
    const angle = Math.random()*Math.PI*2;
    const dist = Math.random()*20;
    const fx = s.x + Math.cos(angle)*dist;
    const fy = s.y + Math.sin(angle)*dist;
    const fsize = Math.random()*5+5;
    let fcolor = fsize<7?'yellow':(fsize<10?'orange':'red');
    foods.push({x:fx,y:fy,size:fsize,color:fcolor});
  }
}

// Input (360°)
document.addEventListener('keydown', e => {
  if(e.key==='w'){snake.dx=0; snake.dy=-1;}
  if(e.key==='s'){snake.dx=0; snake.dy=1;}
  if(e.key==='a'){snake.dx=-1; snake.dy=0;}
  if(e.key==='d'){snake.dx=1; snake.dy=0;}
});

// Firebase update
function updatePlayer(){
  db.ref('players/'+playerId).set({body:snake.segments,color, length:snake.length, name:playerName, dx:snake.dx, dy:snake.dy, dead:snake.dead});
}

// Read all players
const allPlayersRef = db.ref('players/');
let allPlayers = {};
allPlayersRef.on('value', snap => { allPlayers = snap.val()||{}; updateLeaderboard(); });

// Leaderboard
const botId='bot1', botName='我一直在';
function updateLeaderboard(){
  let leaderboardArray = [];
  if(allPlayers[botId]) leaderboardArray.push({name:allPlayers[botId].name,length:allPlayers[botId].length});
  const playerEntries = Object.entries(allPlayers).filter(([id])=>id!==botId).map(([id,p])=>({name:p.name||"New Player",length:p.length}));
  leaderboardArray = leaderboardArray.concat(playerEntries);
  leaderboardArray.sort((a,b)=>b.length-b.length);
  document.getElementById('scores').innerHTML = leaderboardArray.map(p=>`${p.name}: ${p.length}`).join('<br>');
}

// Collision
function checkCollision(x,y){
  for(let id in allPlayers){
    const s = allPlayers[id].body; if(!s) continue;
    for(let seg of s){
      const dx = seg.x - x, dy = seg.y - y;
      if(Math.sqrt(dx*dx + dy*dy)<10){ if(id===playerId && seg===snake.segments[0]) continue; return true; }
    }
  }
  if(x<=0 || x>=MAP_WIDTH || y<=0 || y>=MAP_HEIGHT) return true;
  return false;
}

// Bot
let bot={x:100,y:100,dx:1,dy:0,segments:[],length:5,color:'#ff5555',segmentSize:10};
function updateBot(){
  if(foods.length>0){
    let nearest=foods[0],dist=Math.hypot(bot.x-nearest.x,bot.y-nearest.y);
    for(let f of foods){ const d=Math.hypot(bot.x-f.x, bot.y-f.y); if(d<dist){dist=d; nearest=f;} }
    const angle=Math.atan2(nearest.y-bot.y, nearest.x-bot.x);
    bot.dx=Math.cos(angle); bot.dy=Math.sin(angle);
  }
  bot.x += bot.dx*2; bot.y += bot.dy*2;
  bot.x = Math.max(0, Math.min(MAP_WIDTH, bot.x)); bot.y = Math.max(0, Math.min(MAP_HEIGHT, bot.y));
  bot.segments.unshift({x:bot.x,y:bot.y});
  for(let i=foods.length-1;i>=0;i--){
    const f=foods[i]; if(Math.hypot(f.x-bot.x,f.y-bot.y)<10){ bot.length+=Math.ceil(f.size/3); bot.segmentSize+=f.size/10; foods.splice(i,1); spawnFood(); }
  }
  if(bot.segments.length>bot.length*10) bot.segments.pop();
  if(checkCollision(bot.x, bot.y)){ bot.length=5; bot.segments=[{x:100,y:100}]; bot.x=100; bot.y=100; bot.dx=1; bot.dy=0; bot.segmentSize=10; }
  db.ref('players/'+botId).set({body:bot.segments,color:bot.color,length:bot.length,name:botName,dx:bot.dx,dy:bot.dy});
}

// Mini-map
function drawMiniMap(){
  const miniW=200, miniH=200;
  ctx.save(); ctx.globalAlpha=0.7;
  ctx.fillStyle='#222'; ctx.fillRect(10,10,miniW,miniH);
  ctx.strokeStyle='white'; ctx.lineWidth=2; ctx.strokeRect(10,10,miniW,miniH);
  foods.forEach(f=>{ ctx.fillStyle=f.color; ctx.fillRect(10+f.x/MAP_WIDTH*miniW,10+f.y/MAP_HEIGHT*miniH,3,3); });
  for(let id in allPlayers){ const p=allPlayers[id]; if(!p.body) continue; ctx.fillStyle=p.color; ctx.fillRect(10+p.body[0].x/MAP_WIDTH*miniW,10+p.body[0].y/MAP_HEIGHT*miniH,5,5); }
  ctx.restore();
}

// Game loop
function gameLoop(){
  if(!snake.dead){ snake.x+=snake.dx*2; snake.y+=snake.dy*2;
    if(snake.x<=0 || snake.x>=MAP_WIDTH || snake.y<=0 || snake.y>=MAP_HEIGHT || checkCollision(snake.x,snake.y)){
      spawnFoodFromSnake(snake);
      snake.dead=true;
      snake.length=5;
      snake.segments=[{x:MAP_WIDTH/2,y:MAP_HEIGHT/2}];
      snake.x=MAP_WIDTH/2; snake.y=MAP_HEIGHT/2;
      snake.dx=1; snake.dy=0; snake.segmentSize=10;
      document.getElementById('menu').style.display='block';
    }
    snake.segments.unshift({x:snake.x,y:snake.y});
    for(let i=foods.length-1;i>=0;i--){
      const f=foods[i];
      if(Math.hypot(f.x-snake.x,f.y-snake.y)<10){
        snake.length+=Math.ceil(f.size/3); snake.segmentSize+=f.size/10;
        foods.splice(i,1); spawnFood();
      }
    }
    if(snake.segments.length>snake.length*10) snake.segments.pop();
  }

  camX = snake.x - canvas.width/2; camY = snake.y - canvas.height/2;
  updatePlayer(); updateBot();

  // Plain black background
  ctx.fillStyle='black'; ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.save(); ctx.translate(-camX,-camY);

  // Map boundaries
  ctx.fillStyle='gray'; ctx.fillRect(0,0,MAP_WIDTH,10); ctx.fillRect(0,0,10,MAP_HEIGHT); ctx.fillRect(MAP_WIDTH-10,0,10,MAP_HEIGHT);
  ctx.fillStyle='red'; ctx.fillRect(0,MAP_HEIGHT-10,MAP_WIDTH,10);

  // Food
  foods.forEach(f=>{ ctx.beginPath(); ctx.fillStyle=f.color; ctx.arc(f.x,f.y,f.size,0,Math.PI*2); ctx.fill(); });

  // Snakes
  for(let id in allPlayers){
    const p=allPlayers[id]; if(!p.body) continue;
    for(let i=0;i<p.body.length;i++){
      const seg=p.body[i]; const alpha=1-i/p.body.length; const size=p.segmentSize||10;
      ctx.fillStyle=hexToRGBA(p.color,alpha); ctx.beginPath(); ctx.arc(seg.x,seg.y,size,0,Math.PI*2); ctx.fill();
    }
    if(p.body.length>0){ const head=p.body[0]; ctx.fillStyle='white'; ctx.font='14px sans-serif'; ctx.textAlign='center';
      ctx.fillText(p.name||"New Player",head.x,head.y-20); }
  }

  ctx.restore();
  drawMiniMap();
  requestAnimationFrame(gameLoop);
}

// Start button
document.getElementById('startBtn').onclick = ()=>{
  const nameInput = document.getElementById('playerName').value.trim();
  playerName = nameInput||"New Player";
  let selectedColor = document.getElementById('playerColor').value;
  if(selectedColor.toLowerCase()==='#000000') selectedColor='#00ff00';
  color=selectedColor;
  snake.dead=false; document.getElementById('menu').style.display='none';
  gameLoop();
};

// Resize
window.addEventListener('resize', ()=>{ canvas.width=window.innerWidth; canvas.height=window.innerHeight; });

function hexToRGBA(hex,alpha){ const r=parseInt(hex.slice(1,3),16); const g=parseInt(hex.slice(3,5),16); const b=parseInt(hex.slice(5,7),16); return `rgba(${r},${g},${b},${alpha})`; }
</script>
</body>
</html>

