<!DOCTYPE html>
<html>
<head>
  <title>HMA the Snake.io</title>
  <style>
    body { margin:0; overflow:hidden; background:#111; font-family:sans-serif; }
    #menu {
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      background:white; color:black;
      padding:20px; border-radius:12px;
      text-align:center; z-index:1000;
      box-shadow:0 0 20px rgba(0,0,0,0.6);
    }
    #leaderboard {
      position:absolute; top:10px; right:10px;
      border:2px solid white; padding:10px; background:rgba(0,0,0,0.6); color:white;
      z-index:10;
    }
    #leaderboard table { border-collapse:collapse; width:200px; }
    #leaderboard th, #leaderboard td { border-bottom:1px solid white; padding:4px; text-align:left; }
    canvas { display:block; position:absolute; top:0; left:0; z-index:0; }
    #chatBox {
      position:absolute; top:220px; left:10px;
      width:220px; height:150px;
      background:rgba(0,0,0,0.6); border:2px solid white;
      color:white; padding:5px;
      overflow-y:auto; font-size:14px; z-index:10;
    }
    #chatInput { position:absolute; top:380px; left:10px; width:220px; padding:5px; z-index:10; }
    #fpsPing { position:absolute; top:540px; left:10px; color:white; font-size:14px; z-index:10; }
    #controls { display:none; }
    @media (max-width:768px){ #controls { display:block; } }
  </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>

<div id="menu">
  <h1>HMA the snake.io</h1>
  <input id="playerName" placeholder="Enter your name"/><br><br>
  <input type="color" id="playerColor" value="#00ff00"/><br><br>
  <button id="startBtn">Start Game</button>
</div>

<div id="leaderboard">
  <h3>Leaderboard</h3>
  <table>
    <thead><tr><th>Name</th><th>Size</th></tr></thead>
    <tbody id="scores"></tbody>
  </table>
</div>

<div id="chatBox">Click "/" to type</div>
<input type="text" id="chatInput" placeholder="Type message here">
<div id="fpsPing">FPS: 0 | Ping: 0ms</div>
<div id="controls">Touch controls here (for mobile)</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCut9Zjh8Tv6DjUWeWbBI3zT9ZeujtUMmg",
  authDomain: "snakegame-89cb2.firebaseapp.com",
  databaseURL: "https://snakegame-89cb2-default-rtdb.firebaseio.com/",
  projectId: "snakegame-89cb2",
  storageBucket: "snakegame-89cb2.appspot.com",
  messagingSenderId: "474294584354",
  appId: "1:474294584354:web:fe0583154e5f4f84e0f67b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const MAP_WIDTH = 2000, MAP_HEIGHT = 2000;
let snake = {
  x: MAP_WIDTH/2,
  y: MAP_HEIGHT/2,
  dx: 2,
  dy: 0,
  segments: [{x:MAP_WIDTH/2, y:MAP_HEIGHT/2}],
  length: 5,
  radius: 5,
  dead: true,
  speed: 2,
  invincible: false,
  rainbowColors: [] // for each segment
};
let foods = [], allPlayers = {}, gameStarted = false;
let playerName="New Player", color="#00ff00";

// Player ID
let playerId = localStorage.getItem("playerId");
if(!playerId){ playerId=Math.random().toString(36).substr(2,9); localStorage.setItem("playerId",playerId);}
const playerRef=db.ref("players/"+playerId);
playerRef.onDisconnect().remove();

// Chat
const chatBox=document.getElementById("chatBox");
const chatInput=document.getElementById("chatInput");
chatBox.innerHTML='Click "/" to type';

function sendMessage(msg){
  if(msg.length>0){
    db.ref("chat").push({name:playerName,color:color,text:msg,time:Date.now()});
    chatInput.value=""; chatInput.blur();
  }
}
db.ref("chat").orderByChild("time").startAt(Date.now()).on("child_added",snap=>{
  const data=snap.val();
  chatBox.innerHTML+=`<div><span style="color:${data.color}">${data.name}</span>: ${data.text}</div>`;
  chatBox.scrollTop = chatBox.scrollHeight;
});

// Spawn foods
function spawnFood(){
  const types=[{color:"red",size:5},{color:"yellow",size:10},{color:"blue",size:8},{color:"lime",size:6},{color:"orange",size:12}];
  const f=types[Math.floor(Math.random()*types.length)];
  foods.push({x:Math.random()*MAP_WIDTH,y:Math.random()*MAP_HEIGHT,size:f.size,color:f.color});
}
for(let i=0;i<150;i++) spawnFood();

// Update player
function updatePlayer(){
  playerRef.set({name:playerName,color:color,length:snake.length,radius:snake.radius,body:snake.segments,lastActive:Date.now()});
}

// Controls
window.addEventListener("keydown",e=>{
  if(document.activeElement===chatInput) return;
  if(e.key==="ArrowUp"||e.key==="w"){snake.dx=0;snake.dy=-snake.speed;}
  if(e.key==="ArrowDown"||e.key==="s"){snake.dx=0;snake.dy=snake.speed;}
  if(e.key==="ArrowLeft"||e.key==="a"){snake.dx=-snake.speed;snake.dy=0;}
  if(e.key==="ArrowRight"||e.key==="d"){snake.dx=snake.speed;snake.dy=0;}
});

// Start game
document.getElementById("startBtn").onclick = () => {
  const nameInput = document.getElementById("playerName").value.trim();
  playerName = nameInput||"New Player";
  let selectedColor = document.getElementById("playerColor").value;
  if(selectedColor.toLowerCase()==="#000000") selectedColor="#00ff00";
  color = selectedColor;
  document.getElementById("menu").style.display="none";
  resetSnake(true);
  gameStarted = true;
  gameLoop();
};

// Reset snake
function resetSnake(rainbow=false){
  snake.dead=false;
  snake.length=5; snake.radius=5; snake.speed=2;
  snake.x = MAP_WIDTH/2; snake.y = MAP_HEIGHT/2; snake.dx = snake.speed; snake.dy = 0;
  snake.segments=[{x:MAP_WIDTH/2,y:MAP_HEIGHT/2}];
  snake.rainbowColors = [];
  if(rainbow){
    snake.invincible = true;
    let start = Date.now();
    let colors = ["red","orange","yellow","green","blue","indigo","violet"];
    let interval = setInterval(()=>{
      if(Date.now()-start>4000){ 
        snake.invincible=false; 
        snake.rainbowColors=[]; 
        clearInterval(interval);
      } else {
        // assign random colors for **all segments**
        snake.rainbowColors = snake.segments.map(()=>colors[Math.floor(Math.random()*colors.length)]);
      }
    },50);
  } else { snake.invincible=false; }
}

// Collision
function checkCollision(){
  if(!snake.invincible){
    if(snake.x<=0||snake.x>=MAP_WIDTH||snake.y<=0||snake.y>=MAP_HEIGHT){ dieAndReturnToMenu(); }
    for(let id in allPlayers){
      if(id===playerId) continue;
      const p=allPlayers[id]; if(!p.body) continue;
      for(let i=0;i<p.body.length;i++){
        const seg = p.body[i];
        if(Math.hypot(seg.x-snake.x, seg.y-snake.y)<snake.radius+(p.radius||5)){
          dieAndReturnToMenu();
          return;
        }
      }
    }
  }
}

// Die â†’ menu
function dieAndReturnToMenu(){
  snake.dead=true;
  gameStarted=false;
  document.getElementById("menu").style.display="block";
}

// Game loop
let lastFrame = Date.now(), fps=0;
function gameLoop(){
  const now = Date.now();
  fps = Math.min(60, Math.round(1000/(now-lastFrame)));
  lastFrame = now;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  const camX = snake.x - canvas.width/2, camY = snake.y - canvas.height/2;
  ctx.save(); ctx.translate(-camX,-camY);
  ctx.fillStyle="gray"; ctx.fillRect(0,0,MAP_WIDTH,MAP_HEIGHT);

  if(!snake.dead){
    snake.x += snake.dx;
    snake.y += snake.dy;
    checkCollision();
    snake.segments.unshift({x:snake.x, y:snake.y});
    if(snake.segments.length>snake.length*2) snake.segments.pop();
  }

  // Eat food + respawn
  foods.forEach((f,i)=>{
    const dist=Math.hypot(f.x-snake.x, f.y-snake.y);
    if(dist<snake.radius+f.size/2){
      snake.length+=Math.ceil(f.size/2);
      snake.radius = Math.min(20, snake.radius + Math.ceil(f.size/5));
      foods.splice(i,1);
      spawnFood(); // respawn automatically
    }
    ctx.beginPath(); ctx.fillStyle=f.color; ctx.arc(f.x,f.y,f.size,0,Math.PI*2); ctx.fill();
  });

  // Draw snake
  for(let i=0;i<snake.segments.length;i++){
    const seg = snake.segments[i];
    ctx.beginPath();
    if(snake.invincible && snake.rainbowColors[i]){
      ctx.fillStyle = snake.rainbowColors[i];
    } else {
      ctx.fillStyle = color;
    }
    ctx.arc(seg.x,seg.y,snake.radius,0,Math.PI*2); ctx.fill();
  }

  // Draw other players
  for(let id in allPlayers){
    const p=allPlayers[id]; if(!p.body) continue;
    ctx.fillStyle = p.color||"white";
    p.body.forEach(seg=>{ ctx.beginPath(); ctx.arc(seg.x,seg.y,p.radius||5,0,Math.PI*2); ctx.fill(); });
    if(p.body.length>0){
      const head=p.body[0];
      ctx.font="bold 20px Arial"; ctx.lineWidth=4; ctx.strokeStyle="white";
      ctx.strokeText(p.name||"New Player", head.x, head.y-15);
      ctx.fillStyle=p.color||"white"; ctx.fillText(p.name||"New Player", head.x, head.y-15);
    }
  }

  ctx.restore();
  if(!snake.dead) updatePlayer();
  drawMiniMap();
  document.getElementById("fpsPing").textContent=`FPS: ${fps} | Ping: 0ms`;
  if(gameStarted) requestAnimationFrame(gameLoop);
}

// Mini-map
function drawMiniMap(){
  const mapSize=200;
  ctx.save(); ctx.globalAlpha=0.7;
  ctx.fillStyle="#222"; ctx.fillRect(10,10,mapSize,mapSize);
  for(let id in allPlayers){
    const p=allPlayers[id]; if(!p.body||p.body.length===0) continue;
    const px=10+(p.body[0].x/MAP_WIDTH)*mapSize;
    const py=10+(p.body[0].y/MAP_HEIGHT)*mapSize;
    ctx.fillStyle="white"; ctx.fillRect(px-4,py-4,8,8);
    ctx.fillStyle=p.color||"white"; ctx.fillRect(px-3,py-3,6,6);
  }
  foods.forEach(f=>{
    const fx=10+(f.x/MAP_WIDTH)*mapSize;
    const fy=10+(f.y/MAP_HEIGHT)*mapSize;
    ctx.fillStyle=f.color; ctx.beginPath(); ctx.arc(fx,fy,3,0,Math.PI*2); ctx.fill();
  });
  ctx.restore();
}

// Leaderboard
db.ref("players").on("value",snap=>{
  allPlayers=snap.val()||{};
  updateLeaderboard();
});
function updateLeaderboard(){
  const scores=document.getElementById("scores"); scores.innerHTML="";
  Object.values(allPlayers||{}).filter(p=>p.length>0).sort((a,b)=>b.length-b.length)
    .forEach(p=>{
      const tr=document.createElement("tr");
      const td1=document.createElement("td"); td1.textContent=p.name||"New Player"; td1.style.color=p.color||"white";
      const td2=document.createElement("td"); td2.textContent=p.length;
      tr.appendChild(td1); tr.appendChild(td2); scores.appendChild(tr);
    });
}

// Chat focus
document.addEventListener("keydown",e=>{
  if(e.key==="/" && document.activeElement!==chatInput){ e.preventDefault(); chatInput.focus(); }
  if(e.key==="Enter" && document.activeElement===chatInput){ sendMessage(chatInput.value.trim()); }
});

window.addEventListener("resize",()=>{canvas.width=window.innerWidth; canvas.height=window.innerHeight;});
</script>
</body>
</html>
